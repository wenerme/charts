name: Build Pages

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  schedule:
    - cron: "*/30 * * * *"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
      with:
        ref: ${{ github.head_ref }}
    - name: Build Cache
      id: build-cache
      uses: actions/cache@v2
      with:
        path: cache
        key: ${{ runner.os }}-build-cache
    
    - run: |
        mkdir -p cache
        cd cache
        curl -LOC- https://get.helm.sh/helm-v3.3.0-rc.1-linux-amd64.tar.gz
        tar -zxvf helm-v3.3.0-rc.1-linux-amd64.tar.gz
        sudo mv linux-amd64/helm /usr/local/bin/helm
        cd -
        
        git clone --depth=1 --single-branch --branch gh-pages https://github.com/wenerme/charts charts

    - name: Building
      run: sh ./build/build.sh

    - run: |
        helm repo index charts
        rsync -a public/ charts/
        cp README.md charts/

    - name: Deploy Pages
      uses: JamesIves/github-pages-deploy-action@releases/v3
      with:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        BRANCH: gh-pages # The branch the action should deploy to.
        FOLDER: charts

    - uses: stefanzweifel/git-auto-commit-action@v4
      with:
        commit_message: update mirrors

        commit_user_name: GitHub Actions
        commit_user_email: wenermail@gmail.com
        commit_author: GitHub Actions <wenermail@gmail.com>
